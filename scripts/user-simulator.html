<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz User Simulator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 30px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #007bff;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-info { color: #007bff; }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #007bff;
            transition: width 0.3s ease;
        }
        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .user-card {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 12px;
        }
        .user-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-active { background: #28a745; }
        .status-completed { background: #007bff; }
        .status-error { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Quiz User Simulator</h1>
            <p>Simulate multiple users taking the quiz simultaneously to test server capacity</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="baseUrl">Base URL:</label>
                <input type="url" id="baseUrl" value="http://localhost:3000" placeholder="https://your-app.vercel.app">
            </div>
            <div class="control-group">
                <label for="userCount">Number of Users:</label>
                <input type="number" id="userCount" value="50" min="1" max="1000">
            </div>
            <div class="control-group">
                <label for="quizId">Quiz ID:</label>
                <select id="quizId">
                    <option value="default">Default Quiz</option>
                    <option value="science">Science Quiz</option>
                    <option value="history">History Quiz</option>
                </select>
            </div>
            <div class="control-group">
                <label for="delay">Delay Between Users (ms):</label>
                <input type="number" id="delay" value="100" min="0" max="5000">
            </div>
            <div class="control-group">
                <label for="thinkingTime">Thinking Time Range (ms):</label>
                <input type="text" id="thinkingTime" value="1000-5000" placeholder="min-max">
            </div>
        </div>

        <div style="text-align: center;">
            <button id="startBtn" onclick="startSimulation()">üöÄ Start Simulation</button>
            <button id="stopBtn" onclick="stopSimulation()" disabled>‚èπÔ∏è Stop Simulation</button>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div class="results" id="results" style="display: none;">
            <h3>üìä Simulation Results</h3>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeUsers">0</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completedUsers">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="failedUsers">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="successRate">0%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgResponseTime">0ms</div>
                    <div class="stat-label">Avg Response Time</div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>

            <div class="user-grid" id="userGrid"></div>
        </div>

        <div class="log" id="log">
            <div class="log-entry log-info">Ready to start simulation...</div>
        </div>
    </div>

    <script>
        class UserSimulator {
            constructor(baseUrl, options) {
                this.baseUrl = baseUrl;
                this.options = options;
                this.users = new Map();
                this.results = {
                    total: 0,
                    active: 0,
                    completed: 0,
                    failed: 0,
                    responseTimes: []
                };
                this.isRunning = false;
                this.names = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eve', 'Frank', 'Grace', 'Henry', 'Ivy', 'Jack'];
            }

            generateUserId() {
                return 'sim-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            }

            generateUser() {
                const randomName = this.names[Math.floor(Math.random() * this.names.length)];
                const uniqueId = Math.floor(Math.random() * 10000);
                return {
                    userId: this.generateUserId(),
                    displayName: `${randomName}${uniqueId}`,
                    uniqueId: uniqueId.toString(),
                    status: 'active',
                    progress: 0,
                    answers: []
                };
            }

            log(message, type = 'info') {
                const logDiv = document.getElementById('log');
                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logDiv.appendChild(entry);
                logDiv.scrollTop = logDiv.scrollHeight;
            }

            updateStats() {
                document.getElementById('totalUsers').textContent = this.results.total;
                document.getElementById('activeUsers').textContent = this.results.active;
                document.getElementById('completedUsers').textContent = this.results.completed;
                document.getElementById('failedUsers').textContent = this.results.failed;
                
                const successRate = this.results.total > 0 ? 
                    ((this.results.completed / this.results.total) * 100).toFixed(1) : 0;
                document.getElementById('successRate').textContent = successRate + '%';
                
                const avgResponseTime = this.results.responseTimes.length > 0 ?
                    Math.round(this.results.responseTimes.reduce((a, b) => a + b, 0) / this.results.responseTimes.length) : 0;
                document.getElementById('avgResponseTime').textContent = avgResponseTime + 'ms';
                
                const progress = this.results.total > 0 ? 
                    ((this.results.completed + this.results.failed) / this.results.total) * 100 : 0;
                document.getElementById('progressBar').style.width = progress + '%';
            }

            updateUserGrid() {
                const grid = document.getElementById('userGrid');
                grid.innerHTML = '';
                
                this.users.forEach((user, userId) => {
                    const card = document.createElement('div');
                    card.className = 'user-card';
                    card.innerHTML = `
                        <div>
                            <span class="user-status status-${user.status}"></span>
                            <strong>${user.displayName}</strong>
                        </div>
                        <div>Progress: ${user.progress}%</div>
                        <div>Answers: ${user.answers.length}</div>
                    `;
                    grid.appendChild(card);
                });
            }

            async onboardUser(user) {
                try {
                    const response = await fetch(`${this.baseUrl}/api/users`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.userId,
                            displayName: user.displayName,
                            uniqueId: user.uniqueId
                        })
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return true;
                } catch (error) {
                    this.log(`Onboarding failed for ${user.displayName}: ${error.message}`, 'error');
                    return false;
                }
            }

            async getQuestions() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/quiz/${this.options.quizId}/questions`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    return data.questions;
                } catch (error) {
                    this.log(`Failed to get questions: ${error.message}`, 'error');
                    return [];
                }
            }

            async submitAnswer(user, question, selectedOption, startTime) {
                try {
                    const answerData = {
                        userId: user.userId,
                        quizId: this.options.quizId,
                        questionId: question.id,
                        selectedOption: selectedOption.toString(),
                        questionStartTimestamp: startTime,
                        responseTimeMs: Date.now() - startTime,
                        round: Math.floor(question.index / 5) + 1
                    };

                    const response = await fetch(`${this.baseUrl}/api/quiz/${this.options.quizId}/submit`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(answerData)
                    });

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const responseTime = Date.now() - startTime;
                    this.results.responseTimes.push(responseTime);
                    
                    return { success: true, responseTime };
                } catch (error) {
                    this.log(`Answer submission failed for ${user.displayName}: ${error.message}`, 'error');
                    return { success: false, error: error.message };
                }
            }

            async simulateUser(userId) {
                const user = this.generateUser();
                user.userId = userId;
                this.users.set(userId, user);
                this.results.total++;
                this.results.active++;
                this.updateStats();
                this.updateUserGrid();

                this.log(`Starting simulation for ${user.displayName}`, 'info');

                // Onboard user
                const onboarded = await this.onboardUser(user);
                if (!onboarded) {
                    user.status = 'error';
                    this.results.active--;
                    this.results.failed++;
                    this.updateStats();
                    this.updateUserGrid();
                    return;
                }

                // Get questions
                const questions = await this.getQuestions();
                if (questions.length === 0) {
                    user.status = 'error';
                    this.results.active--;
                    this.results.failed++;
                    this.updateStats();
                    this.updateUserGrid();
                    return;
                }

                // Answer questions
                for (let i = 0; i < questions.length; i++) {
                    if (!this.isRunning) break;
                    
                    const question = questions[i];
                    question.index = i;
                    const startTime = Date.now();

                    // Random thinking time
                    const [min, max] = this.options.thinkingTime.split('-').map(Number);
                    const thinkingTime = Math.random() * (max - min) + min;
                    await this.sleep(thinkingTime);

                    // Random answer
                    const selectedOption = Math.floor(Math.random() * question.options.length);
                    
                    const result = await this.submitAnswer(user, question, selectedOption, startTime);
                    user.answers.push(result);
                    user.progress = Math.round(((i + 1) / questions.length) * 100);
                    
                    this.updateUserGrid();
                    
                    // Small delay between questions
                    await this.sleep(200);
                }

                // Mark as completed
                user.status = 'completed';
                this.results.active--;
                this.results.completed++;
                this.log(`Completed simulation for ${user.displayName}`, 'success');
                this.updateStats();
                this.updateUserGrid();
            }

            async runSimulation() {
                this.isRunning = true;
                this.log(`Starting simulation with ${this.options.userCount} users`, 'info');
                
                const promises = [];
                
                for (let i = 0; i < this.options.userCount; i++) {
                    if (!this.isRunning) break;
                    
                    const userId = `sim-${i}-${Date.now()}`;
                    const promise = this.simulateUser(userId);
                    promises.push(promise);
                    
                    // Delay between user creation
                    if (i < this.options.userCount - 1) {
                        await this.sleep(this.options.delay);
                    }
                }
                
                await Promise.allSettled(promises);
                
                if (this.isRunning) {
                    this.log('Simulation completed!', 'success');
                } else {
                    this.log('Simulation stopped by user', 'info');
                }
                
                this.isRunning = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }

            stop() {
                this.isRunning = false;
                this.log('Stopping simulation...', 'info');
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        let simulator = null;

        function startSimulation() {
            const baseUrl = document.getElementById('baseUrl').value;
            const userCount = parseInt(document.getElementById('userCount').value);
            const quizId = document.getElementById('quizId').value;
            const delay = parseInt(document.getElementById('delay').value);
            const thinkingTime = document.getElementById('thinkingTime').value;

            if (!baseUrl || !userCount || userCount < 1) {
                alert('Please enter valid values');
                return;
            }

            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('results').style.display = 'block';

            simulator = new UserSimulator(baseUrl, {
                userCount,
                quizId,
                delay,
                thinkingTime
            });

            simulator.runSimulation();
        }

        function stopSimulation() {
            if (simulator) {
                simulator.stop();
            }
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="log-entry log-info">Log cleared...</div>';
        }
    </script>
</body>
</html> 